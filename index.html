<!DOCTYPE html>
<html lang="pt-br">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newmarket - Pro Scanner</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    ...
    </head>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #0f172a; --bg-card: #1e293b; --accent: #38bdf8;
            --warning: #f59e0b; --danger: #ef4444; --success: #10b981;
            --text-main: #f1f5f9;
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-primary); 
            color: var(--text-main); margin: 0; padding-bottom: 30px;
            overscroll-behavior-y: contain; 
        }
        
        /* Previne o flash de login */
        #loader-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-primary); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 5000; 
        }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(56, 189, 248, 0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); display: none; align-items: center; justify-content: center; z-index: 2000; }
        #app-content { display: none; }

        .card { background: var(--bg-card); margin: 15px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 15px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; outline: none; }
        .modo-edicao { border: 2px solid var(--warning) !important; background: #2d2a1e !important; }
        
        button { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--accent); color: #0f172a; }
        .btn-scan { background: #334155; color: white; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-wa { background: #25d366; color: white; margin-top: 10px; }
        
        /* Container do Scanner */
        #scanner-visual { display: none; width: 100%; height: 200px; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; position: relative; }
        #scanner-visual video { width: 100%; height: 100%; object-fit: cover; }
        .laser { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: red; box-shadow: 0 0 8px red; z-index: 10; animation: scanAnim 2s infinite; }
        @keyframes scanAnim { 0%, 100% { top: 20%; } 50% { top: 80%; } }

        .history-item { background: #0f172a; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid var(--accent); }
        .badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; float: right; font-weight: bold; }
        .badge-vencido { background: var(--danger); color: white; }
        .badge-alerta { background: var(--warning); color: #000; }
        .badge-ok { background: var(--success); color: #000; }
        
        .actions { display: flex; gap: 8px; margin-top: 12px; }
        .btn-sm { flex: 1; padding: 10px; font-size: 0.75rem; color: white; background: #334155; border-radius: 5px; }
        #modal-barcode { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; display:none; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

    <div id="loader-overlay"><div class="spinner"></div><p style="color: var(--accent); margin-top:10px;">A validar acesso...</p></div>

    <div id="login-screen">
        <div class="card" style="width: 85%; max-width: 350px;">
            <h2 style="color: var(--accent); text-align: center; margin-top:0;">NEWMARKET PRO</h2>
            <input type="email" id="l-email" placeholder="E-mail">
            <input type="password" id="l-senha" placeholder="Senha">
            <button class="btn-main" id="btn-entrar">ENTRAR</button>
        </div>
    </div>

    <div id="app-content">
        <header style="padding: 15px; text-align: center; border-bottom: 1px solid #334155;"><strong>NEWMARKET PRO</strong></header>
        
        <div class="card">
            <div id="scanner-visual"><div class="laser"></div></div>
            <button type="button" class="btn-scan" id="btn-scan">üì∑ LER C√ìDIGO DE BARRAS</button>

            <input type="text" id="nome" placeholder="Nome do Produto">
            <input type="text" id="ean" placeholder="EAN (C√≥digo)" inputmode="numeric">
            <input type="date" id="validade">
            <input type="number" id="qtd" placeholder="Quantidade">
            <button class="btn-main" id="btn-salvar">GUARDAR LOTE</button>
            <button class="btn-wa" id="btn-wa">üì≤ RELAT√ìRIO WHATSAPP</button>
        </div>

        <div id="lista" style="padding: 0 15px;"></div>
        <button onclick="window.sair()" style="background:transparent; color:var(--danger); margin: 20px; font-size: 0.9rem;">Terminar Sess√£o</button>
    </div>

    <div id="modal-barcode" onclick="this.style.display='none'">
        <div style="background:white; padding:20px; border-radius:10px; text-align:center;" onclick="event.stopPropagation()">
            <h3 id="m-nome" style="color:black; margin-bottom:5px;"></h3>
            <svg id="barcode-canvas"></svg><br>
            <button onclick="document.getElementById('modal-barcode').style.display='none'" style="background:var(--danger); color:white; margin-top:10px; padding:10px;">FECHAR</button>
        </div>
    </div>
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
    getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, getDoc, 
    query, orderBy, limit, serverTimestamp, enableIndexedDbPersistence 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCP-R0LVH_lEmZ3ks1Z4f64HwhzxmShZpg",
    authDomain: "new-market-d4c5a.firebaseapp.com",
    projectId: "new-market-d4c5a",
    storageBucket: "new-market-d4c5a.firebasestorage.app",
    messagingSenderId: "261011659066",
    appId: "1:261011659066:web:36d66d6125b8db65621803"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let editandoId = null;

enableIndexedDbPersistence(db).catch(() => console.log("Offline mode ON"));

const loader = (s) => document.getElementById('loader-overlay').style.display = s ? 'flex' : 'none';
const toBR = (v) => { if(!v) return "S/ Data"; const [y,m,d]=v.split('-'); return `${d}/${m}/${y}`; };

// --- SCANNER ---
let scannerAtivo = false;
window.toggleScanner = () => {
    if(scannerAtivo) {
        Quagga.stop();
        document.getElementById('scanner-visual').style.display = 'none';
        scannerAtivo = false;
        return;
    }

    document.getElementById('scanner-visual').style.display = 'block';
    Quagga.init({
        inputStream: { name: "Live", type: "LiveStream", target: document.getElementById('scanner-visual'), constraints: { facingMode: "environment" } },
        decoder: { readers: ["ean_reader", "code_128_reader", "ean_8_reader"] }
    }, (err) => {
        if(err) { alert("C√¢mara indispon√≠vel"); return; }
        Quagga.start();
        scannerAtivo = true;
    });

    Quagga.onDetected((res) => {
        document.getElementById('ean').value = res.codeResult.code;
        if(navigator.vibrate) navigator.vibrate(100);
        window.toggleScanner();
    });
};
document.getElementById('btn-scan').addEventListener('click', window.toggleScanner);

// --- AUTENTICA√á√ÉO ---
onAuthStateChanged(auth, (u) => {
    loader(false);
    if(u) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        carregar();
        const eanUrl = new URLSearchParams(window.location.search).get('ean');
        if(eanUrl) setTimeout(() => window.showBC(eanUrl, "Consulta"), 1000);
    } else {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('app-content').style.display = 'none';
    }
});

document.getElementById('btn-entrar').addEventListener('click', () => {
    loader(true);
    signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-senha').value)
        .catch(() => { loader(false); alert("Erro!"); });
});

// --- CARREGAR LISTA ---
async function carregar() {
    loader(true);
    try {
        const q = query(collection(db, "estoque"), orderBy("timestamp", "desc"), limit(20));
        const snap = await getDocs(q);
        const lista = document.getElementById('lista');
        lista.innerHTML = "";
        snap.forEach(d => {
            const i = d.data();
            const dV = new Date(i.validade); const hj = new Date();
            const diff = Math.ceil((dV - hj) / 86400000);
            let s = {l:'OK', c:'badge-ok'};
            if(diff <= 0) s = {l:'VENCIDO', c:'badge-vencido'};
            else if(diff <= 15) s = {l:'CR√çTICO', c:'badge-alerta'};

            lista.innerHTML += `
                <div class="history-item">
                    <span class="badge ${s.c}">${s.l}</span>
                    <strong>${i.nome || 'S/ NOME'}</strong><br>
                    <small>EAN: ${i.ean} | Venc: ${toBR(i.validade)}</small>
                    <div class="actions">
                        <button class="btn-sm" onclick="window.showBC('${i.ean}','${i.nome}')">üîé BIPAR</button>
                        <button class="btn-sm" onclick="window.ed('${d.id}')">‚úèÔ∏è EDITAR</button>
                        <button class="btn-sm" style="background:var(--danger)" onclick="window.del('${d.id}')">üóëÔ∏è</button>
                    </div>
                </div>`;
        });
    } catch(err) {
        alert("Erro ao carregar produtos: " + err.message);
    } finally {
        loader(false);
    }
}

// --- SALVAR / ATUALIZAR ---
document.getElementById('btn-salvar').addEventListener('click', async () => {
    const d = { 
        nome: document.getElementById('nome').value, 
        ean: document.getElementById('ean').value, 
        validade: document.getElementById('validade').value, 
        quantidade: Number(document.getElementById('qtd').value),
        timestamp: serverTimestamp() 
    };
    if(!d.ean || !d.validade) return alert("Dados em falta!");
    loader(true);
    try {
        if(editandoId) await updateDoc(doc(db, "estoque", editandoId), d);
        else await addDoc(collection(db, "estoque"), d);
        editandoId = null;
        document.getElementById('btn-salvar').innerText = "GUARDAR LOTE";
        await carregar();
        // limpa inputs
        document.getElementById('nome').value = '';
        document.getElementById('ean').value = '';
        document.getElementById('validade').value = '';
        document.getElementById('qtd').value = '';
        document.getElementById('ean').classList.remove('modo-edicao');
    } catch(err) {
        alert("Erro ao salvar: " + err.message);
    } finally {
        loader(false);
    }
});

// --- MOSTRAR C√ìDIGO DE BARRAS ---
window.showBC = (ean, nome) => {
    document.getElementById('modal-barcode').style.display = 'flex';
    document.getElementById('m-nome').innerText = nome;
    JsBarcode("#barcode-canvas", ean, { format: "CODE128", width: 2, height: 80, displayValue: true });
};

// --- EDITAR PRODUTO ---
window.ed = async (id) => {
    loader(true);
    try {
        const d = await getDoc(doc(db, "estoque", id));
        if(!d.exists()) throw new Error("Produto n√£o encontrado");
        const i = d.data();
        document.getElementById('nome').value = i.nome;
        document.getElementById('ean').value = i.ean;
        document.getElementById('validade').value = i.validade;
        document.getElementById('qtd').value = i.quantidade;
        document.getElementById('ean').classList.add('modo-edicao');
        editandoId = id;
        document.getElementById('btn-salvar').innerText = "ATUALIZAR";
        window.scrollTo({top:0, behavior:'smooth'});
    } catch(err) {
        alert("Erro ao carregar o produto: " + err.message);
    } finally {
        loader(false);
    }
};

// --- EXCLUIR PRODUTO ---
window.del = async (id) => {
    if (!confirm("Apagar?")) return;
    loader(true);
    try {
        await deleteDoc(doc(db, "estoque", id));
        await carregar();
    } catch(err) {
        alert("Erro ao apagar o produto: " + err.message);
    } finally {
        loader(false);
    }
};

// --- LOGOUT ---
window.sair = () => signOut(auth);

// --- RELAT√ìRIO WHATSAPP ---
document.getElementById('btn-wa').addEventListener('click', () => {
    const itens = document.querySelectorAll('.history-item');
    let m = `*üìä NEWMARKET PRO - ${new Date().toLocaleDateString('pt-BR')}*%0A`;
    m += `‚úÖ *Total: ${itens.length} itens*%0A----------------------------%0A`;
    itens.forEach(i => {
        const n = i.querySelector('strong').innerText;
        const s = i.querySelector('small').innerText;
        const ean = s.match(/EAN: (\d+)/)?.[1] || "";
        m += `üì¶ *${n}*%0Aüî¢ ${s}%0Aüîó Ver: https://newmarket.pkacci.com.br/?ean=${ean}%0A----------------------------%0A`;
    });
    window.open(`https://wa.me/?text=${m}`);
});
    </script>
</body>
</html>
