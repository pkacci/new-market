<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Newmarket - Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #0f172a; --bg-card: #1e293b; --accent: #38bdf8;
            --warning: #f59e0b; --danger: #ef4444; --success: #10b981;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
        }

        /* Impede o pull-to-refresh acidental e define o fundo */
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-main); 
            margin: 0; 
            padding-bottom: 30px;
            overscroll-behavior-y: contain; 
        }
        
        /* Loader Inicial (Inicia vis√≠vel para evitar o piscar do login) */
        #loader-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-primary); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 5000; 
        }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(56, 189, 248, 0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Telas (Iniciam ocultas) */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); display: none; align-items: center; justify-content: center; z-index: 2000; }
        #app-content { display: none; }

        .card { background: var(--bg-card); margin: 15px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 15px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--accent); }
        .modo-edicao { border: 2px solid var(--warning) !important; background: #2d2a1e !important; }
        
        button { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        button:active { opacity: 0.8; transform: scale(0.98); }
        .btn-main { background: var(--accent); color: #0f172a; }
        .btn-wa { background: #25d366; color: white; margin-top: 10px; }
        
        .history-item { background: #0f172a; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid var(--accent); }
        .badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; float: right; font-weight: bold; }
        .badge-vencido { background: var(--danger); color: white; }
        .badge-alerta { background: var(--warning); color: #000; }
        .badge-ok { background: var(--success); color: #000; }
        
        .actions { display: flex; gap: 8px; margin-top: 12px; }
        .btn-sm { flex: 1; padding: 10px; font-size: 0.75rem; color: white; background: #334155; border-radius: 5px; }
        
        #modal-barcode { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; display:none; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

    <div id="loader-overlay"><div class="spinner"></div><p style="color: var(--accent); margin-top:10px;">A carregar Newmarket...</p></div>

    <div id="login-screen">
        <div class="card" style="width: 85%; max-width: 350px;">
            <h2 style="color: var(--accent); text-align: center; margin-top:0;">NEWMARKET PRO</h2>
            <input type="email" id="l-email" placeholder="E-mail">
            <input type="password" id="l-senha" placeholder="Senha">
            <button class="btn-main" id="btn-entrar">ACESSAR</button>
        </div>
    </div>

    <div id="app-content">
        <header style="padding: 15px; text-align: center; border-bottom: 1px solid #334155;">
            <strong>NEWMARKET PRO</strong>
        </header>
        
        <div class="card">
            <input type="text" id="nome" placeholder="Nome do Produto">
            <input type="text" id="ean" placeholder="EAN (C√≥digo)" inputmode="numeric">
            <input type="date" id="validade">
            <input type="number" id="qtd" placeholder="Quantidade">
            <button class="btn-main" id="btn-salvar">REGISTRAR LOTE</button>
            <button class="btn-wa" id="btn-wa">üì≤ ENVIAR RELAT√ìRIO</button>
        </div>

        <div id="lista" style="padding: 0 15px;"></div>
        <button onclick="window.sair()" style="background:transparent; color:var(--danger); margin: 20px; font-size: 0.9rem;">Sair do Sistema</button>
    </div>

    <div id="modal-barcode" onclick="this.style.display='none'">
        <div style="background:white; padding:20px; border-radius:10px; text-align:center;" onclick="event.stopPropagation()">
            <h3 id="m-nome" style="color:black; margin-bottom:5px;"></h3>
            <svg id="barcode-canvas"></svg><br>
            <button onclick="document.getElementById('modal-barcode').style.display='none'" style="background:var(--danger); color:white; margin-top:10px; padding:10px;">FECHAR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, getDoc, query, orderBy, limit, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCP-R0LVH_lEmZ3ks1Z4f64HwhzxmShZpg",
            authDomain: "new-market-d4c5a.firebaseapp.com",
            projectId: "new-market-d4c5a",
            storageBucket: "new-market-d4c5a.firebasestorage.app",
            messagingSenderId: "261011659066",
            appId: "1:261011659066:web:36d66d6125b8db65621803"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let editandoId = null;

        enableIndexedDbPersistence(db).catch(() => console.log("Modo offline ativo"));

        const loader = (s) => document.getElementById('loader-overlay').style.display = s ? 'flex' : 'none';
        const toBR = (val) => { if(!val) return "S/ Data"; const [y, m, d] = val.split('-'); return `${d}/${m}/${y}`; };
        
        const getSt = (val) => {
            const d = new Date(val); const hj = new Date();
            const diff = Math.ceil((d - hj) / (1000 * 60 * 60 * 24));
            if (diff <= 0) return { l: 'VENCIDO', c: 'badge-vencido' };
            if (diff <= 15) return { l: 'CR√çTICO', c: 'badge-alerta' };
            return { l: 'OK', c: 'badge-ok' };
        };

        // --- MONITOR DE SESS√ÉO CORRIGIDO ---
        onAuthStateChanged(auth, (u) => {
            loader(false); // Remove o splash screen inicial
            
            if(u) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                carregar();
                
                // Abre c√≥digo automaticamente se vier via link
                const urlParams = new URLSearchParams(window.location.search);
                const eanUrl = urlParams.get('ean');
                if(eanUrl) setTimeout(() => window.showBC(eanUrl, "Consulta R√°pida"), 1000);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
            }
        });

        document.getElementById('btn-entrar').addEventListener('click', () => {
            loader(true);
            const email = document.getElementById('l-email').value;
            const senha = document.getElementById('l-senha').value;
            signInWithEmailAndPassword(auth, email, senha).catch(e => { loader(false); alert("Dados inv√°lidos."); });
        });

        async function carregar() {
            const q = query(collection(db, "estoque"), orderBy("timestamp", "desc"), limit(20));
            const snap = await getDocs(q);
            const lista = document.getElementById('lista');
            lista.innerHTML = "";
            snap.forEach(d => {
                const i = d.data(); const s = getSt(i.validade);
                lista.innerHTML += `
                    <div class="history-item">
                        <span class="badge ${s.c}">${s.l}</span>
                        <strong>${i.nome || 'PRODUTO S/ NOME'}</strong><br>
                        <small>EAN: ${i.ean} | Venc: ${toBR(i.validade)}</small>
                        <div class="actions">
                            <button class="btn-sm" onclick="window.showBC('${i.ean}','${i.nome}')">üîé BIPAR</button>
                            <button class="btn-sm" onclick="window.ed('${d.id}')">‚úèÔ∏è EDITAR</button>
                            <button class="btn-sm" style="background:var(--danger)" onclick="window.del('${d.id}')">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
        }

        document.getElementById('btn-salvar').addEventListener('click', async () => {
            const n = document.getElementById('nome').value;
            const e = document.getElementById('ean').value;
            const v = document.getElementById('validade').value;
            const q = document.getElementById('qtd').value;
            if(!e || !v) return alert("Preencha EAN e Data!");
            loader(true);
            const d = { nome: n, ean: e, validade: v, quantidade: Number(q), usuario: auth.currentUser.email, timestamp: serverTimestamp() };
            try {
                if(editandoId) await updateDoc(doc(db, "estoque", editandoId), d);
                else await addDoc(collection(db, "estoque"), d);
                location.reload();
            } catch(err) { alert("Erro ao guardar."); loader(false); }
        });

        window.showBC = (ean, nome) => {
            document.getElementById('modal-barcode').style.display = 'flex';
            document.getElementById('m-nome').innerText = nome;
            JsBarcode("#barcode-canvas", ean, { format: "CODE128", width: 2, height: 80, displayValue: true });
        };

        window.ed = async (id) => {
            loader(true); const d = await getDoc(doc(db, "estoque", id)); const i = d.data();
            document.getElementById('nome').value = i.nome; document.getElementById('ean').value = i.ean;
            document.getElementById('validade').value = i.validade; document.getElementById('qtd').value = i.quantidade;
            document.getElementById('ean').classList.add('modo-edicao'); editandoId = id;
            document.getElementById('btn-salvar').innerText = "ATUALIZAR";
            window.scrollTo({top: 0, behavior: 'smooth'}); loader(false);
        };

        window.del = async (id) => { if(confirm("Apagar registro?")) { loader(true); await deleteDoc(doc(db, "estoque", id)); carregar(); loader(false); }};
        window.sair = () => signOut(auth);

        document.getElementById('btn-wa').addEventListener('click', () => {
            const itens = document.querySelectorAll('.history-item');
            let m = `*üìä NEWMARKET PRO - ${new Date().toLocaleDateString('pt-BR')}*%0A`;
            m += `‚úÖ *Total de Itens: ${itens.length}*%0A----------------------------%0A`;
            itens.forEach(i => {
                const n = i.querySelector('strong').innerText;
                const s = i.querySelector('small').innerText;
                const b = i.querySelector('.badge').innerText;
                const ean = s.match(/EAN: (\d+)/)?.[1] || "";
                m += `üõçÔ∏è *${n}*%0Aüî¢ ${s}%0A‚ö†Ô∏è Status: ${b}%0A`;
                if(ean) m += `üîó Bipar: https://newmarket.pkacci.com.br/?ean=${ean}%0A`;
                m += "----------------------------%0A";
            });
            window.open(`https://wa.me/?text=${m}`);
        });
    </script>
</body>
</html>
