<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NewMarket Pro v2</title>

<style>
:root{
--bg:#0f172a;
--card:#1e293b;
--accent:#38bdf8;
--danger:#ef4444;
--warning:#f59e0b;
--success:#10b981;
--text:#f1f5f9;
}

body{
margin:0;
font-family:Arial;
background:var(--bg);
color:var(--text);
}

.card{
background:var(--card);
margin:15px;
padding:15px;
border-radius:12px;
}

input,button{
width:100%;
padding:12px;
margin:6px 0;
border-radius:8px;
border:none;
}

button{font-weight:bold;cursor:pointer;}

.btn-main{background:var(--accent);}
.btn-warning{background:var(--warning);}
.btn-danger{background:var(--danger);color:#fff;}

.history-item{
background:#0f172a;
padding:10px;
margin-top:8px;
border-left:4px solid var(--accent);
border-radius:8px;
}

.badge{
float:right;
padding:3px 8px;
border-radius:4px;
font-size:0.7rem;
}

.badge-danger{background:var(--danger);}
.badge-warning{background:var(--warning);color:#000;}
.badge-ok{background:var(--success);color:#000;}

#loader{
position:fixed;
top:0;left:0;
width:100%;height:100%;
background:#000;
display:flex;
align-items:center;
justify-content:center;
z-index:9999;
}

</style>
</head>
<body>

<div id="loader">Carregando...</div>

<div class="card">
<h3>ðŸ“Š Dashboard</h3>
Total Lotes: <strong id="d-lotes">0</strong><br>
Total Unidades: <strong id="d-unidades">0</strong><br>
Vencidos: <strong id="d-vencidos">0</strong><br>
CrÃ­ticos: <strong id="d-criticos">0</strong>
</div>

<div class="card">
<h3>ðŸ“¦ Cadastro</h3>
<input id="nome" placeholder="Nome">
<input id="ean" placeholder="EAN">
<input type="date" id="validade">
<input type="number" id="qtd" placeholder="Quantidade">
<button class="btn-main" id="salvar">Guardar Lote</button>
<button class="btn-warning" id="saida">Dar SaÃ­da (FEFO)</button>
<button id="historicoBtn">Ver HistÃ³rico</button>
</div>

<div class="card">
<h3>ðŸ“‹ Estoque</h3>
<div id="lista"></div>
</div>

<div id="modalHistorico" style="display:none;" class="card">
<h3>ðŸ“œ MovimentaÃ§Ãµes</h3>
<div id="movList"></div>
<button onclick="modalHistorico.style.display='none'">Fechar</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "SUA_KEY",
authDomain: "SEU_DOMINIO",
projectId: "SEU_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const loader = (s)=>document.getElementById("loader").style.display=s?"flex":"none";

async function carregar(){

loader(true);

const snap = await getDocs(collection(db,"estoque"));

let totalLotes=0,totalUnidades=0,vencidos=0,criticos=0;

const agrupado={};

snap.forEach(d=>{
totalLotes++;
const i=d.data();
totalUnidades+=i.quantidade;

const diff=Math.ceil((new Date(i.validade)-new Date())/86400000);

if(diff<=0)vencidos++;
else if(diff<=15)criticos++;

if(!agrupado[i.ean]){
agrupado[i.ean]={nome:i.nome,total:0,lotes:[]};
}
agrupado[i.ean].total+=i.quantidade;
agrupado[i.ean].lotes.push({id:d.id,...i});
});

document.getElementById("d-lotes").innerText=totalLotes;
document.getElementById("d-unidades").innerText=totalUnidades;
document.getElementById("d-vencidos").innerText=vencidos;
document.getElementById("d-criticos").innerText=criticos;

if(Notification.permission==="default")Notification.requestPermission();

if(Notification.permission==="granted"){
if(vencidos>0){
new Notification("âš  Produtos vencidos",{body:`${vencidos} produtos vencidos.`});
}
}

const lista=document.getElementById("lista");
lista.innerHTML="";

for(const ean in agrupado){

const p=agrupado[ean];

lista.innerHTML+=`
<div class="history-item">
<strong>${p.nome}</strong> (${p.total} un)
<button onclick="saidaFEFO('${ean}')">SaÃ­da</button>
</div>
`;
}

loader(false);
}

document.getElementById("salvar").onclick=async()=>{
loader(true);
await addDoc(collection(db,"estoque"),{
nome:nome.value,
ean:ean.value,
validade:validade.value,
quantidade:Number(qtd.value),
timestamp:serverTimestamp()
});
carregar();
};

async function saidaFEFO(ean){

const quantidade=Number(prompt("Quantidade:"));
if(!quantidade)return;

loader(true);

const q=query(collection(db,"estoque"),orderBy("validade","asc"));
const snap=await getDocs(q);

let restante=quantidade;

for(const d of snap.docs){
const i=d.data();
if(i.ean!==ean)continue;
if(restante<=0)break;

if(i.quantidade<=restante){
restante-=i.quantidade;
await deleteDoc(doc(db,"estoque",d.id));
}else{
await updateDoc(doc(db,"estoque",d.id),{
quantidade:i.quantidade-restante
});
restante=0;
}

await addDoc(collection(db,"movimentacoes"),{
tipo:"saida",
ean:i.ean,
nome:i.nome,
quantidade:quantidade,
timestamp:serverTimestamp()
});
}

if(restante>0)alert("Estoque insuficiente");

carregar();
}

document.getElementById("saida").onclick=()=>saidaFEFO(ean.value);

document.getElementById("historicoBtn").onclick=async()=>{
modalHistorico.style.display="block";
const snap=await getDocs(query(collection(db,"movimentacoes"),orderBy("timestamp","desc")));
movList.innerHTML="";
snap.forEach(d=>{
const m=d.data();
movList.innerHTML+=`
<div class="history-item">
${m.tipo.toUpperCase()} - ${m.nome} - ${m.quantidade}
</div>`;
});
};

carregar();

</script>
</body>
</html>
